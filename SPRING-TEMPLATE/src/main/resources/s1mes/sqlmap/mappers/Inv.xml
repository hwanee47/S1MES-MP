<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Inv">

	<select id="selectStdPdInfo" resultClass="HashMap">
		/*Inv.selectStdPdInfo*/
		WITH A AS(
			SELECT 
				RORD_NUM
				,SNO AS RORD_SNO
				,COALESCE(SUM(BND_CNT),0) QTY
			FROM 
				TB_LE_915 LE_915 
			WHERE 
				SUBSTR(ST_PO,1,1)='P' 
			AND KND = 'P' 
			AND BD_DIV <![CDATA[<>]]>'B' 
			AND COALESCE(TAOUT_DT,'') = '' 
			AND (SELECT ORD_TYPE FROM TB_SD_100 SD_100 WHERE SD_100.RORD_NUM = LE_915.RORD_NUM) IN ('S','I')
			GROUP BY RORD_NUM,SNO
		),GOAL_CHG(RORD_NUM, RORD_SNO, RORD_NUM_BF, RORD_SNO_BF, LEVEL, PROC_CD) AS (
			SELECT
				P1.RORD_NUM
				,P1.SNO
				,P1.RORD_NUM_BF
				,P1.RORD_SNO_BF
				,0
				,P1.PROC_CD	
			FROM
				TB_SD_110 P1
				,A P2
			WHERE
				P1.RORD_NUM = P2.RORD_NUM AND P1.SNO = P2.RORD_SNO
			
			UNION ALL
			
			SELECT
				P1.RORD_NUM
				,P1.SNO
				,P1.RORD_NUM_BF
				,P1.RORD_SNO_BF
				,P2.LEVEL+1
				,P1.PROC_CD	
			FROM
				TB_SD_110 P1
				,GOAL_CHG P2
			WHERE
				P1.RORD_NUM_BF = P2.RORD_NUM AND P1.RORD_SNO_BF = P2.RORD_SNO
			AND P1.PROC_CD NOT IN ( '95', '98')	  
		
		),B AS(
		
			SELECT
				A.RORD_NUM
				,A.RORD_SNO
				,A.IN_WAR_QTY-COALESCE(B.TAOUT_QTY,0) QTY
			FROM
				(
					SELECT
					 	A.RORD_NUM 
					 	,A.RORD_SNO
					 	,A.IN_WAR_QTY
					 	,B.RORD_NUM_BF
					 	,B.RORD_SNO_BF
					FROM 
						TB_LE_450 A
						,GOAL_CHG B	
					WHERE
						A.RORD_NUM = B.RORD_NUM
					AND A.RORD_SNO = B.RORD_SNO
					AND A.IN_WAR_TYPE = 'IL'
					AND A.FAC_CD='P'
					AND B.PROC_CD NOT IN ( '89' )	 
				)A
			LEFT OUTER JOIN 
				(
					SELECT
						A.RORD_NUM
						,A.RORD_SNO
						,SUM(A.TAOUT_QTY) TAOUT_QTY
					FROM
						TB_LE_460 A
						,GOAL_CHG B
					WHERE
						A.RORD_NUM = B.RORD_NUM
					AND A.RORD_SNO = B.RORD_SNO
					AND A.FAC_CD='P'
					AND B.PROC_CD NOT IN ( '89' )
					AND A.TAOUT_TYPE NOT IN ('OE','OX')
					AND A.CREATE_PG_ID <![CDATA[<>]]>  'LE_LCM_900'	
					GROUP BY A.RORD_NUM,A.RORD_SNO
				)B
			ON (A.RORD_NUM=B.RORD_NUM AND A.RORD_SNO=B.RORD_SNO)
			WHERE
				A.IN_WAR_QTY - COALESCE(B.TAOUT_QTY,0) > 0 
				
			
		),C AS(
			SELECT
				A.RORD_NUM
				,A.SNO AS RORD_SNO
				,SUM(A.REQ_CNT) QTY
			FROM
				TB_SD_310 A
				,GOAL_CHG B
			WHERE
				A.RORD_NUM = B.RORD_NUM
			AND A.SNO = B.RORD_SNO
			AND	A.PROC_CD <![CDATA[<>]]> '89'
			AND A.TAOUT_TYPE IN ('O3', 'O4')
			GROUP BY
				A.RORD_NUM,A.SNO
		),D AS(
			SELECT
				A.RORD_NUM
				,A.RORD_SNO
				,SUM(CASE WHEN A.TAOUT_TYPE = 'OA' OR A.TAOUT_TYPE ='OF' THEN A.TAOUT_QTY END) QTY_OAOF
				,SUM(CASE WHEN A.TAOUT_TYPE ='OE' THEN A.TAOUT_QTY END) QTY_OE
			FROM
				TB_LE_460 A
				,GOAL_CHG B
			WHERE
				A.RORD_NUM = B.RORD_NUM
			AND A.RORD_SNO = B.RORD_SNO
			AND A.FAC_CD = 'P'
			AND	B.PROC_CD NOT IN ('89','95', '98')
			AND A.TAOUT_TYPE IN ('OA','OF','OE')
			GROUP BY A.RORD_NUM, A.RORD_SNO
		)
		
		SELECT
			SUM(CURRENT_QTY) AS CURRENT_QTY
			,SUM(GOAL_CHG_QTY) AS GOAL_CHG_QTY
			,SUM(SHIP_QTY) AS SHIP_QTY
			,SUM(STOCK_QTY) AS STOCK_QTY
			,SUM(CURRENT_QTY) - SUM(GOAL_CHG_QTY) - SUM(SHIP_QTY) - SUM(STOCK_QTY) AS STANDARD_PRODUCT_INV
		FROM
		(
			SELECT
				SUM(A.QTY) AS CURRENT_QTY
				,0 AS GOAL_CHG_QTY
				,0 AS SHIP_QTY
				,0 AS STOCK_QTY
			FROM
				A
				
			UNION ALL
			
			SELECT
				0 AS CURRENT_QTY
				,SUM(B.QTY) AS GOAL_CHG_QTY
				,0 AS SHIP_QTY
				,0 AS STOCK_QTY
			FROM
				B
				
			UNION ALL
			
			SELECT
				0 AS CURRENT_QTY
				,0 AS GOAL_CHG_QTY
				,SUM(C.QTY) AS SHIP_QTY
				,0 AS STOCK_QTY
			FROM
				C
			
			UNION ALL
			
			SELECT
				0 AS CURRENT_QTY
				,0 AS GOAL_CHG_QTY
				,0 AS SHIP_QTY
				,SUM(D.QTY_OAOF)-SUM(D.QTY_OE) AS STOCK_QTY
			FROM
				D
			
		)RESULT

	</select>
	
	
	<select id="selectInvPdRordMngInfo" resultClass="HashMap">
		/*Inv.selectInvPdRordMngInfo*/
		with rordInfo as (
			
			SELECT 
				SD_110.RORD_NUM,
				SD_110.SNO,
				SD_100.ACC_DIV,
				SD_100.RORD_DT,
				SD_100.DELV,
				SD_100.BUSIPLA,
				SD_100.VEND_CD,
				(SELECT VEND_NAME FROM TB_SD_930 WHERE VEND_CD=SD_100.VEND_CD),
				SD_100.PERSON,
				I.H05KNM AS PERSON_NM, /*담당자명*/
				SD_100.ORD_TYPE,
				(SELECT KND FROM TB_SD_910 WHERE SPEC_ID=SD_110.SPEC_ID), /*품종*/
				(SELECT ITEM_TYPE FROM TB_SD_910 WHERE SPEC_ID=SD_110.SPEC_ID), /*품목*/
				(SELECT STD_CD FROM TB_SD_910 WHERE SPEC_ID=SD_110.SPEC_ID), /*규격*/
				SD_110.DIA_A, /*호칭경*/
				SD_110.MM_ODIA_A, /*MM외경(A)*/
				SD_110.MM_ODIA_B, /*MM외경(B)*/
				SD_110.ORD_THK_A, /*수주두께(A)*/
				SD_110.MNG_THK_A, /*관리두께(A)*/
				SD_110.OSD_STAT, /*표면상태*/
				SD_110.OSD_PROC,	/*표면처리*/
				SD_110.LEN_MM,	/*길이*/
				SD_110.QTY,		/*주문수량*/
				SD100_LE450.FAC_CD,
				SD100_LE450.IN_WAR_QTY,
				/*SD_110.ORD_CHG_QTY,*/
				COALESCE(LE_460.ORD_CHG_QTY,0) AS ORD_CHG_QTY, /*20170222 이송 목적전환*/
				SD_110.BND,	/*속본*/
				SD_110.SPEC_ID,	/*SPEC_ID*/
				(SELECT MM_CONV_THK_A FROM TB_SD_910 WHERE SPEC_ID=SD_110.SPEC_ID), /*MM두께(A)*/
				SD_110.PIPE_DIV,
				SD_110.PIPE_ANG,
				SD_110.LEN_UNIT,
				SD_110.LEN_FT,
				SD_110.LEN_IN,
				SD_110.MM_CONV_LEN,
				SD_110.PROD_ORD_USE,
				SD_110.STRA,
				SD_110.PIPE_SQUA,
				SD_110.ROD_R,
				SD_110.ETC_YN, 
				SD_110.DA_MAX,
				SD_110.DA_MIN, 
				SD_110.SHL_MAX, 
				SD_110.SHL_MIN,
				SD_110.RTF_LIMIT_MAX, 
				SD_110.RTF_LIMIT_MIN,
				SD_110.LEN_LIMIT_MAX,
				SD_110.LEN_LIMIT_MIN, 
				SD_110.FRT_MAX, 
				SD_110.FRT_MIN, 
				SD_110.BED_LIMIT_MAX, 
				SD_110.BED_LIMIT_MIN, 
				SD_110.ODIA_LIMIT_MAX,
				SD_110.ODIA_LIMIT_MIN,
				SD_110.IDIA_LIMIT_MAX,
				SD_110.IDIA_LIMIT_MIN,
				SD_110.THK_LIMIT_MAX,
				SD_110.THK_LIMIT_MIN,
				SD_110.SIDE_LEN_LIMIT_A_MAX,
				SD_110.SIDE_LEN_LIMIT_A_MIN,
				SD_110.SIDE_LEN_LIMIT_B_MAX,
				SD_110.SIDE_LEN_LIMIT_B_MIN,
				SD_110.HEAT_YN,
				SD_110.ADH,
				SD_110.MRK_LOC,
				SD_110.MRK_WAY,
				SD_110.DUAL_MRK,
				SD_110.DUAL_MRK_TXT,
				SD_110.STR_CLR_TYP,
				SD_110.STR_QTY,
				SD_110.STR_CLR,
				SD_110.STEEL_BAND_DIV,
				SD_110.PCK_TOP,
				SD_110.PCK_CEN,
				SD_110.PCK_END,
				(SELECT WEIGHT_M FROM TB_SD_910 WHERE SPEC_ID=SD_110.SPEC_ID),
				COALESCE((SELECT DIV_01 FROM TB_SM_111
			                             WHERE CD_CAT = '10004'
			                               AND CD_DETAIL = (SELECT QUALI FROM TB_SD_910 WHERE SPEC_ID=SD_110.SPEC_ID))
			                        , 0) AS SPEC_GRAV,
				COALESCE(SD_310.REQ_CNT, 0) AS REQ_CNT,
				(SD100_LE450.IN_WAR_QTY-SD_110.ORD_CHG_QTY-COALESCE(SD_310.REQ_CNT, 0)) AS SELL_AVAIL_INV_QTY
				,COALESCE((SELECT SUM(TAOUT_QTY) FROM TB_LE_460 WHERE TAOUT_TYPE IN ('O7') AND SD_110.RORD_NUM = RORD_NUM AND SD_110.SNO = RORD_SNO AND SD100_LE450.FAC_CD = FAC_CD GROUP BY RORD_NUM,RORD_SNO,FAC_CD),0) RE_WORK_QTY
				,SD_910.SCHE
			FROM
				TB_SD_100 SD_100,
				TB_SD_110 SD_110,
				(
					/*입고실적이 있는 수주 SELECT*/
					SELECT
						A.RORD_NUM,
						A.SNO,
						B.FAC_CD, 
						SUM(B.IN_WAR_QTY) AS IN_WAR_QTY
					FROM
						TB_SD_110 A,
						TB_LE_450 B
					WHERE
						A.RORD_NUM=B.RORD_NUM
					AND A.SNO=B.RORD_SNO
					AND B.IN_WAR_TYPE <![CDATA[<>]]> 'IX' /*20170814추가 (입고취소제외)*/
					GROUP BY A.RORD_NUM,A.SNO,B.FAC_CD
				) SD100_LE450
				LEFT OUTER JOIN CPDATLIB.INSAMASTER I ON SD_100.PERSON = I.H05SB
				LEFT OUTER JOIN 
				(
					SELECT
						RORD_NUM,
						SNO,
						FAC_CD,
						SUM(REQ_CNT) AS REQ_CNT
					FROM
						TB_SD_310
					WHERE
						TAOUT_TYPE <![CDATA[<>]]> 'OE' 
					GROUP BY
						RORD_NUM,SNO,FAC_CD
				) SD_310 ON SD_110.RORD_NUM = SD_310.RORD_NUM AND SD_110.SNO = SD_310.SNO AND SD100_LE450.FAC_CD = SD_310.FAC_CD
				LEFT OUTER JOIN
				(
					SELECT
						RORD_NUM
						,RORD_SNO
						,FAC_CD
						,SUM(TAOUT_QTY) ORD_CHG_QTY
					FROM
						TB_LE_460
					WHERE
						TAOUT_TYPE IN ('OL')
					GROUP BY RORD_NUM,RORD_SNO,FAC_CD
				) LE_460 ON SD_110.RORD_NUM = LE_460.RORD_NUM AND SD_110.SNO = LE_460.RORD_SNO AND SD100_LE450.FAC_CD = LE_460.FAC_CD
				LEFT OUTER JOIN TB_SD_910 SD_910 ON SD_110.SPEC_ID = SD_910.SPEC_ID 
			WHERE 
				SD_100.RORD_NUM=SD_110.RORD_NUM
			AND SD_110.RORD_NUM=SD100_LE450.RORD_NUM
			AND SD_110.SNO=SD100_LE450.SNO
			AND SD_110.PROC_CD NOT IN ('98','99')
			AND SD_100.ACC_DIV LIKE '2'
			AND SD_100.ORD_TYPE LIKE 'S'
			AND SD100_LE450.FAC_CD = 'P'
			
		), findRordInfo(FIND_RORD_NUM, FIND_RORD_SNO, RORD_NUM, RORD_SNO, RORD_NUM_BF, RORD_SNO_BF, FAC_CD) as (
			
			select
				V1.RORD_NUM as FIND_RORD_NUM
				, V1.SNO as FIND_RORD_SNO
				, T1.RORD_NUM
				, T1.SNO as RORD_SNO
				, RORD_NUM_BF
				, RORD_SNO_BF
				, V1.FAC_CD
			from
				TB_SD_110	T1
				, rordInfo	V1
			where
				T1.RORD_NUM = V1.RORD_NUM and T1.SNO = V1.SNO
						
			union all
			
			select
				P1.FIND_RORD_NUM
				, P1.FIND_RORD_SNO
				, T1.RORD_NUM
				, T1.SNO 		as RORD_SNO
				, T1.RORD_NUM_BF
				, T1.RORD_SNO_BF
				, P1.FAC_CD
			from
				TB_SD_110 as	T1
				, findRordInfo P1
			where
				T1.RORD_NUM = P1.RORD_NUM_BF
				and T1.SNO = P1.RORD_SNO_BF
		)
		
		SELECT
				SUM(V1.IN_WAR_QTY) AS IN_WAR_QTY
				,SUM(V1.ORD_CHG_QTY) AS ORD_CHG_QTY
				,SUM(V1.REQ_CNT) AS REQ_CNT
				,SUM((V1.IN_WAR_QTY - V1.ORD_CHG_QTY - V1.REQ_CNT - V1.RE_WORK_QTY)) AS SELL_AVAIL_INV_QTY
				,SUM(V1.RE_WORK_QTY) AS RE_WORK_QTY
		FROM
			rordInfo V1
			,findRordInfo P1
		WHERE
			V1.RORD_NUM = P1.FIND_RORD_NUM AND V1.SNO = P1.FIND_RORD_SNO AND V1.FAC_CD = P1.FAC_CD
		AND P1.RORD_NUM_BF IS NULL
		AND (V1.IN_WAR_QTY - V1.ORD_CHG_QTY - V1.REQ_CNT - V1.RE_WORK_QTY)<![CDATA[<>]]>0
		
	</select>
</sqlMap>
